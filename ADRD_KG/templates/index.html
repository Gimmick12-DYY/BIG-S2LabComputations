<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disease Type Matrix Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #0056b3;
            background-color: #e9ecef;
        }
        .upload-area.dragover {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .matrix-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            padding: 20px;
        }
        .loading {
            display: none;
        }
        .error-message {
            display: none;
            color: #dc3545;
        }
        .success-message {
            display: none;
            color: #28a745;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
        }
        .disease-count-item {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .matrix-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row bg-primary text-white py-4 mb-4">
            <div class="col-12 text-center">
                <h1><i class="fas fa-chart-bar"></i> Disease Type Matrix Analyzer</h1>
                <p class="lead">Upload your Excel file to visualize disease type information as interactive matrices</p>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-upload"></i> Upload Disease Data</h3>
                    </div>
                    <div class="card-body">
                        <!-- File Upload Area -->
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <h4>Drag & Drop your Excel file here</h4>
                            <p class="text-muted">or click to browse</p>
                            <input type="file" id="fileInput" class="d-none" accept=".xlsx,.xls,.csv">
                            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-folder-open"></i> Choose File
                            </button>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <button class="btn btn-success w-100" id="generateSampleBtn">
                                    <i class="fas fa-database"></i> Generate Sample Data
                                </button>
                            </div>
                            <div class="col-md-6">
                                <a href="/download_sample" class="btn btn-info w-100">
                                    <i class="fas fa-download"></i> Download Template
                                </a>
                            </div>
                        </div>

                        <!-- Loading and Messages -->
                        <div class="loading text-center mt-3" id="loadingDiv">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Processing your data...</p>
                        </div>

                        <div class="error-message alert alert-danger mt-3" id="errorMessage"></div>
                        <div class="success-message alert alert-success mt-3" id="successMessage"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            <!-- Data Summary -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="stats-card">
                        <h3><i class="fas fa-info-circle"></i> Dataset Summary</h3>
                        <div class="row" id="summaryStats">
                            <!-- Summary statistics will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Disease Counts -->
            <div class="row mt-4">
                <div class="col-lg-6">
                    <div class="matrix-container">
                        <h4><i class="fas fa-list"></i> Disease Type Distribution</h4>
                        <div id="diseaseCounts">
                            <!-- Disease counts will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="matrix-container">
                        <h4><i class="fas fa-chart-pie"></i> Age Statistics</h4>
                        <div id="ageStats">
                            <!-- Age statistics will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Matrix Visualizations -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="matrix-container">
                        <h4><i class="fas fa-th"></i> Disease Type Matrices</h4>
                        <div id="matrixVisualizations">
                            <!-- Matrix visualizations will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Tables -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="matrix-container">
                        <h4><i class="fas fa-table"></i> Matrix Data Tables</h4>
                        <div id="matrixTables">
                            <!-- Matrix tables will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loadingDiv = document.getElementById('loadingDiv');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const resultsSection = document.getElementById('resultsSection');

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        // Generate sample data button
        document.getElementById('generateSampleBtn').addEventListener('click', () => {
            processData('/sample_data');
        });

        function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('file', file);
            processData('/upload', formData);
        }

        function processData(url, formData = null) {
            showLoading();
            hideMessages();

            const requestOptions = {
                method: formData ? 'POST' : 'GET',
                body: formData
            };

            fetch(url, requestOptions)
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showSuccess(`Successfully processed ${data.filename}`);
                        displayResults(data);
                    } else {
                        showError(data.error || 'An error occurred while processing the file');
                    }
                })
                .catch(error => {
                    hideLoading();
                    showError('Network error: ' + error.message);
                });
        }

        function displayResults(data) {
            // Show results section
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });

            // Display summary statistics
            displaySummaryStats(data.summary);

            // Display disease counts
            displayDiseaseCounts(data.disease_counts);

            // Display age statistics
            displayAgeStats(data.summary.age_stats);

            // Display matrix visualizations
            displayMatrixVisualizations(data.plots);

            // Display matrix tables
            displayMatrixTables(data.matrices);
        }

        function displaySummaryStats(summary) {
            const summaryHtml = `
                <div class="col-md-3">
                    <div class="text-center">
                        <h2>${summary.total_records}</h2>
                        <p>Total Records</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h2>${summary.total_columns}</h2>
                        <p>Columns</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h2>${summary.unique_diseases || 'N/A'}</h2>
                        <p>Disease Types</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h2>${summary.most_common_count || 'N/A'}</h2>
                        <p>Most Common</p>
                    </div>
                </div>
            `;
            document.getElementById('summaryStats').innerHTML = summaryHtml;
        }

        function displayDiseaseCounts(diseaseCounts) {
            let html = '';
            for (const [disease, count] of Object.entries(diseaseCounts)) {
                html += `
                    <div class="disease-count-item">
                        <strong>${disease}</strong>: ${count} cases
                    </div>
                `;
            }
            document.getElementById('diseaseCounts').innerHTML = html;
        }

        function displayAgeStats(ageStats) {
            if (!ageStats) {
                document.getElementById('ageStats').innerHTML = '<p class="text-muted">No age data available</p>';
                return;
            }

            const html = `
                <div class="row">
                    <div class="col-6">
                        <p><strong>Mean Age:</strong> ${ageStats.mean} years</p>
                        <p><strong>Std Dev:</strong> ${ageStats.std} years</p>
                    </div>
                    <div class="col-6">
                        <p><strong>Min Age:</strong> ${ageStats.min} years</p>
                        <p><strong>Max Age:</strong> ${ageStats.max} years</p>
                    </div>
                </div>
            `;
            document.getElementById('ageStats').innerHTML = html;
        }

        function displayMatrixVisualizations(plots) {
            let html = '';
            for (const [matrixName, plotData] of Object.entries(plots)) {
                html += `
                    <div class="mb-4">
                        <h5>${matrixName.replace(/_/g, ' ').toUpperCase()}</h5>
                        <img src="data:image/png;base64,${plotData}" class="matrix-image" alt="${matrixName}">
                    </div>
                `;
            }
            document.getElementById('matrixVisualizations').innerHTML = html;
        }

        function displayMatrixTables(matrices) {
            let html = '';
            for (const [matrixName, matrixData] of Object.entries(matrices)) {
                html += `
                    <div class="mb-4">
                        <h5>${matrixName.replace(/_/g, ' ').toUpperCase()}</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        ${Object.keys(matrixData).map(key => `<th>${key}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(matrixData).map(([rowKey, rowData]) => 
                                        `<tr>
                                            <td><strong>${rowKey}</strong></td>
                                            ${Object.values(rowData).map(value => `<td>${value}</td>`).join('')}
                                        </tr>`
                                    ).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            document.getElementById('matrixTables').innerHTML = html;
        }

        function showLoading() {
            loadingDiv.style.display = 'block';
        }

        function hideLoading() {
            loadingDiv.style.display = 'none';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }
    </script>
</body>
</html>
